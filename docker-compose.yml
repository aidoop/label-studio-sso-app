# ==============================================================================
# Production Docker Compose Configuration
# ==============================================================================
#
# 이 파일은 배포된 이미지를 사용하여 프로덕션 환경을 구성합니다.
#
# 포함된 서비스:
# 1. PostgreSQL 13.18 - 데이터베이스
# 2. Label Studio Custom 1.20.0-sso.32 - SSO 통합 Label Studio
# 3. Label Studio SSO App 1.0.0 - SSO 샘플 애플리케이션
#
# 사용 방법:
#   docker compose -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.prod.yml logs -f
#   docker compose -f docker-compose.prod.yml down
#
# ==============================================================================

services:
  # ==============================================================================
  # PostgreSQL 데이터베이스
  # ==============================================================================
  postgres:
    image: postgres:13.18
    container_name: label-studio-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-labelstudio}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres_data:/var/lib/postgresql/data

    ports:
      - "5432:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - labelstudio

  # ==============================================================================
  # Label Studio Custom (SSO 통합)
  # ==============================================================================
  labelstudio:
    # GitHub Container Registry 배포 이미지
    image: ghcr.io/aidoop/label-studio-custom:1.20.0-sso.36

    container_name: label-studio-app
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    environment:
      # Database
      DJANGO_DB: default
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-labelstudio}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

      # Django
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # SSO Configuration
      JWT_SSO_NATIVE_USER_ID_CLAIM: user_id
      JWT_SSO_COOKIE_NAME: ls_auth_token
      JWT_SSO_TOKEN_PARAM: token
      JWT_SSO_COOKIE_PATH: /
      SSO_TOKEN_EXPIRY: ${SSO_TOKEN_EXPIRY:-600}

      # Label Studio
      LABEL_STUDIO_HOST: ${LABEL_STUDIO_HOST:-http://localhost:8080}

      # Custom Version
      CUSTOM_VERSION: "1.20.0-sso.36"
      CUSTOM_RELEASE_DATE: "2025-11-14"

      # Cookie Settings
      SESSION_COOKIE_DOMAIN: ${SESSION_COOKIE_DOMAIN}
      CSRF_COOKIE_DOMAIN: ${CSRF_COOKIE_DOMAIN}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-0}
      CSRF_COOKIE_SECURE: ${CSRF_COOKIE_SECURE:-0}
      SESSION_COOKIE_SAMESITE: ${SESSION_COOKIE_SAMESITE:-}
      CSRF_COOKIE_SAMESITE: ${CSRF_COOKIE_SAMESITE:-}

      # Security Headers
      CSP_FRAME_ANCESTORS: ${CSP_FRAME_ANCESTORS:-}
      CONTENT_SECURITY_POLICY: ${CONTENT_SECURITY_POLICY:-}
      X_FRAME_OPTIONS: ${X_FRAME_OPTIONS:-}

      # Other
      FEATURE_FLAGS_OFFLINE: true
      STORAGE_PERSISTENCE: true

    volumes:
      - labelstudio_data:/label-studio/data

    ports:
      - "${LABEL_STUDIO_PORT:-8080}:8080"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - labelstudio

  # ==============================================================================
  # Label Studio SSO Sample App
  # ==============================================================================
  sso-app:
    # GitHub Container Registry 배포 이미지
    image: ghcr.io/aidoop/label-studio-sso-app:1.0.8

    # 또는 latest 태그 사용
    # image: ghcr.io/aidoop/label-studio-sso-app:latest

    container_name: label-studio-sso-app
    restart: unless-stopped

    depends_on:
      labelstudio:
        condition: service_healthy

    environment:
      # Node Environment
      NODE_ENV: production

      # Server Port
      PORT: 3000

      # CORS Settings
      CORS_ORIGIN: ${CORS_ORIGIN:-*}

      # Frontend URL (for redirects and CORS)
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}

      # Cookie Domain (for subdomain sharing)
      COOKIE_DOMAIN: ${COOKIE_DOMAIN:-.localhost}

      # Label Studio Configuration
      LABEL_STUDIO_URL: http://labelstudio:8080

      # Label Studio API Token
      # 초기 사용자 생성 후 토큰을 발급받아 .env 파일에 설정하세요
      LABEL_STUDIO_API_TOKEN: ${LABEL_STUDIO_API_TOKEN:-YOUR_API_TOKEN_HERE}

    ports:
      - "3000:3000"

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - labelstudio

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  postgres_data:
    driver: local

  labelstudio_data:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  labelstudio:
    driver: bridge
